name: ðŸ¤– Issue & PR Management

on:
  issues:
    types: [opened, edited, closed, reopened]
  pull_request:
    types: [opened, edited, closed, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  schedule:
    # Run every day at midnight UTC to clean up stale issues
    - cron: '0 0 * * *'

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  # ðŸ·ï¸ Auto-label issues and PRs
  auto-label:
    name: ðŸ·ï¸ Auto Label
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
      - name: ðŸ·ï¸ Label new issues
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const { issue } = context.payload;
            const title = issue.title.toLowerCase();
            const body = issue.body?.toLowerCase() || '';
            
            const labels = [];
            
            // Auto-label based on title/content
            if (title.includes('bug') || title.includes('error') || title.includes('broken')) {
              labels.push('ðŸ› bug');
            }
            
            if (title.includes('feature') || title.includes('enhancement') || body.includes('feature request')) {
              labels.push('âœ¨ enhancement');
            }
            
            if (title.includes('doc') || title.includes('readme') || body.includes('documentation')) {
              labels.push('ðŸ“š documentation');
            }
            
            if (title.includes('question') || title.includes('help') || title.includes('how to')) {
              labels.push('â“ question');
            }
            
            if (title.includes('performance') || body.includes('slow') || body.includes('optimization')) {
              labels.push('âš¡ performance');
            }
            
            if (title.includes('security') || body.includes('vulnerability')) {
              labels.push('ðŸ”’ security');
            }
            
            // Add priority labels based on keywords
            if (title.includes('urgent') || title.includes('critical') || body.includes('production')) {
              labels.push('ðŸ”¥ high priority');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
              
              console.log(`Added labels: ${labels.join(', ')}`);
            }

      - name: ðŸ·ï¸ Label new pull requests
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { pull_request } = context.payload;
            const title = pull_request.title.toLowerCase();
            const body = pull_request.body?.toLowerCase() || '';
            
            const labels = [];
            
            // Auto-label based on PR title/content
            if (title.includes('fix') || title.includes('bug')) {
              labels.push('ðŸ› bug fix');
            }
            
            if (title.includes('feat') || title.includes('feature') || title.includes('add')) {
              labels.push('âœ¨ feature');
            }
            
            if (title.includes('docs') || title.includes('readme')) {
              labels.push('ðŸ“š documentation');
            }
            
            if (title.includes('refactor') || title.includes('cleanup')) {
              labels.push('â™»ï¸ refactor');
            }
            
            if (title.includes('test') || title.includes('spec')) {
              labels.push('ðŸ§ª tests');
            }
            
            if (title.includes('deps') || title.includes('dependencies') || title.includes('update')) {
              labels.push('ðŸ“¦ dependencies');
            }
            
            if (title.includes('breaking') || body.includes('breaking change')) {
              labels.push('ðŸ’¥ breaking change');
            }
            
            // Check if it's a draft
            if (pull_request.draft) {
              labels.push('ðŸš§ work in progress');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pull_request.number,
                labels: labels
              });
              
              console.log(`Added labels: ${labels.join(', ')}`);
            }

  # ðŸ‘‹ Welcome new contributors
  welcome:
    name: ðŸ‘‹ Welcome Contributors
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
      - name: ðŸ‘‹ Welcome new issue creators
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if this is the user's first issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: context.payload.issue.user.login,
              state: 'all'
            });
            
            if (issues.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `## ðŸ‘‹ Welcome to PromptBoost!
                
Thanks for opening your first issue! We're excited to have you as part of our community.

### ðŸ“‹ What happens next?
1. Our maintainers will review your issue
2. If it's a bug, we'll try to reproduce it
3. If it's a feature request, we'll discuss feasibility
4. We'll update you with any questions or progress

### ðŸ¤ Ways to contribute
- ðŸ› Report bugs and issues
- ðŸ’¡ Suggest new features
- ðŸ“š Improve documentation
- ðŸ§ª Write tests
- ðŸ’» Submit pull requests

### ðŸ“š Helpful links
- [Contributing Guide](https://github.com/${context.repo.owner}/${context.repo.repo}#contributing)
- [Code of Conduct](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CODE_OF_CONDUCT.md)
- [Documentation](https://github.com/${context.repo.owner}/${context.repo.repo}#readme)

Thanks again for contributing! ðŸš€`
              });
            }

      - name: ðŸ‘‹ Welcome new contributors
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if this is the user's first PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: context.payload.pull_request.user.login,
              state: 'all'
            });
            
            if (prs.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `## ðŸŽ‰ First Pull Request!

Thank you for your first contribution to PromptBoost! 

### âœ… PR Checklist
Please make sure your PR:
- [ ] Follows our coding standards
- [ ] Includes tests for new functionality
- [ ] Updates documentation if needed
- [ ] Has a clear, descriptive title
- [ ] Explains what changes were made and why

### ðŸ” Review Process
- Our maintainers will review your code
- We might suggest some changes
- Once approved, we'll merge your PR
- You'll become a contributor! ðŸŽŠ

### ðŸ†˜ Need Help?
If you need any assistance, feel free to:
- Comment on this PR with questions
- Check our [Contributing Guide](https://github.com/${context.repo.owner}/${context.repo.repo}#contributing)
- Reach out in [Discussions](https://github.com/${context.repo.owner}/${context.repo.repo}/discussions)

Thanks for making PromptBoost better! ðŸš€`
              });
            }

  # ðŸ§¹ Cleanup stale issues and PRs
  cleanup:
    name: ðŸ§¹ Cleanup Stale Items
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: ðŸ§¹ Mark stale issues and PRs
        uses: actions/stale@v8
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: |
            ## ðŸ˜´ This issue has been marked as stale
            
            This issue has been automatically marked as stale because it has not had recent activity. 
            
            ### ðŸ”„ What happens next?
            - If no activity occurs within 7 days, this issue will be automatically closed
            - To keep it open, just add a comment or remove the stale label
            - If you're still experiencing this issue, please let us know!
            
            Thank you for your contributions! ðŸ™
          stale-pr-message: |
            ## ðŸ˜´ This pull request has been marked as stale
            
            This PR has been automatically marked as stale because it has not had recent activity.
            
            ### ðŸ”„ What happens next?
            - If no activity occurs within 7 days, this PR will be automatically closed
            - To keep it open, just add a comment or remove the stale label
            - Consider rebasing if there are conflicts
            
            Thank you for your contribution! ðŸ™
          close-issue-message: |
            ## ðŸ”’ Issue Closed
            
            This issue was automatically closed due to lack of activity. 
            
            If you're still experiencing this problem, please feel free to reopen this issue or create a new one.
          close-pr-message: |
            ## ðŸ”’ Pull Request Closed
            
            This PR was automatically closed due to lack of activity.
            
            If you'd like to continue working on this, please feel free to reopen or create a new PR.
          days-before-stale: 30
          days-before-close: 7
          stale-issue-label: 'ðŸ˜´ stale'
          stale-pr-label: 'ðŸ˜´ stale'
          exempt-issue-labels: 'ðŸ“Œ pinned,ðŸ”’ security,ðŸ”¥ high priority'
          exempt-pr-labels: 'ðŸ“Œ pinned,ðŸ”’ security,ðŸ”¥ high priority'
          operations-per-run: 100

  # ðŸ“Š Generate project metrics
  metrics:
    name: ðŸ“Š Project Metrics
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: ðŸ“Š Update project metrics
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const bugIssues = issues.filter(issue => 
              issue.labels.some(label => label.name.includes('bug'))
            ).length;
            
            const featureRequests = issues.filter(issue => 
              issue.labels.some(label => label.name.includes('enhancement'))
            ).length;
            
            console.log(`ðŸ“Š Project Status:`);
            console.log(`- Open Issues: ${issues.length}`);
            console.log(`- Open PRs: ${prs.length}`);
            console.log(`- Bug Reports: ${bugIssues}`);
            console.log(`- Feature Requests: ${featureRequests}`);
            
            // You could extend this to create issues with metrics reports
            // or update a project dashboard
